<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Redefinir Senha</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root {
    --azul-escuro: #1D2B50;
    --azul-claro: #349BCE;
    --cinza-claro: #f2f2f2;
    --cinza-texto: #5a5a5a;
    --erro: #e74c3c;
    --sucesso: #2ecc71;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: 0;
    background-color: var(--azul-escuro);
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Inter', sans-serif;
  }

  .container {
    background-color: var(--cinza-claro);
    padding: 48px 40px 36px;
    border-radius: 18px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    width: 100%;
    max-width: 440px;
    text-align: center;
    animation: fadeIn 0.5s ease-out;
    position: relative;
  }

  .logo {
    width: 200px;
    margin: 0 auto 28px auto;
    display: block;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }

  h2 {
    color: var(--azul-escuro);
    margin-bottom: 24px;
    font-size: 26px;
    font-weight: 600;
  }

  .input-group {
    position: relative;
    margin-bottom: 20px;
  }

  input {
    width: 100%;
    padding: 14px 44px 14px 14px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 16px;
    outline: none;
    transition: border 0.3s ease;
  }

  input:focus {
    border-color: var(--azul-claro);
  }

  .toggle-password {
    cursor: pointer;
    width: 22px;
    height: 22px;
    stroke: #999;
    transition: stroke 0.3s ease;
    position: absolute;
    top: 50%;
    right: 14px;
    transform: translateY(-50%);
  }

  .toggle-password:hover {
    stroke: var(--azul-claro);
  }

  .eye-open {
    transition: opacity 0.3s ease;
  }

  .strike {
    stroke-dasharray: 22;
    stroke-dashoffset: 22;
    transition: stroke-dashoffset 0.4s ease;
  }
  .strike.active {
    stroke-dashoffset: 0;
  }

  button {
    width: 100%;
    background-color: var(--azul-claro);
    color: white;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
  }

  button:hover {
    background-color: #2c89b6;
    transform: scale(1.02);
  }

  .mensagem {
    font-size: 14px;
    margin-top: 12px;
    font-weight: 500;
  }

  .mensagem.erro {
    color: var(--erro);
  }

  .mensagem.sucesso {
    color: var(--sucesso);
  }

  .icon-success {
    width: 70px;
    height: 70px;
    margin-bottom: 16px;
    animation: popIn 0.5s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes popIn {
    0% {
      opacity: 0;
      transform: scale(0.7);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>
</head>
<body>

  <!-- Formulário de redefinição -->
  <div class="container" id="form-container">
    <img src="logo.png" alt="Logo" class="logo" />
    <h2>Redefinir Senha</h2>

    <div class="input-group">
      <input type="password" id="novaSenha" placeholder="Digite a nova senha" />
      <!-- SVG olho com risquinho animado -->
      <svg class="toggle-password" onclick="toggleSenha('novaSenha', this)" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" >
        <g class="eye-open" style="opacity: 1;">
          <path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7z" fill="none" stroke="#999" stroke-width="2"/>
          <circle cx="12" cy="12" r="3" stroke="#999" stroke-width="2" fill="none"/>
        </g>
        <line class="strike" x1="4" y1="20" x2="20" y2="4" stroke="#349BCE" stroke-width="2" stroke-linecap="round" />
      </svg>
    </div>

    <div class="input-group">
      <input type="password" id="confirmSenha" placeholder="Confirme a nova senha" />
      <!-- Mesmo SVG para consistência -->
      <svg class="toggle-password" onclick="toggleSenha('confirmSenha', this)" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" >
        <g class="eye-open" style="opacity: 1;">
          <path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7z" fill="none" stroke="#999" stroke-width="2"/>
          <circle cx="12" cy="12" r="3" stroke="#999" stroke-width="2" fill="none"/>
        </g>
        <line class="strike" x1="4" y1="20" x2="20" y2="4" stroke="#349BCE" stroke-width="2" stroke-linecap="round" />
      </svg>
    </div>

    <button onclick="enviarNovaSenha()">Confirmar nova senha</button>
    <div class="mensagem erro" id="error-msg"></div>
  </div>

  <!-- Tela de sucesso (inicialmente oculta) -->
  <div class="container" id="sucesso-container" style="display: none;">
    <svg class="icon-success" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="10" fill="#349BCE"/>
      <path d="M8 12.5L11 15.5L16.5 9.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <h2>Senha redefinida!</h2>
    <p class="mensagem sucesso" id="redirect-msg">Redirecionando para o login em 3...</p>
  </div>

 <script>
  function toggleSenha(idInput, svg) {
    const input = document.getElementById(idInput);
    const eyeOpen = svg.querySelector('.eye-open');
    const strike = svg.querySelector('.strike');

    if (input.type === "password") {
      input.type = "text";
      eyeOpen.style.opacity = '0.3';       // olho “fechado” (diminuído)
      strike.classList.add('active');      // mostra risquinho com animação
    } else {
      input.type = "password";
      eyeOpen.style.opacity = '1';         // olho aberto normal
      strike.classList.remove('active');   // esconde risquinho
    }
  }

  function getTokenFromURL() {
    const hash = window.location.hash.substring(1); // remove o #
    const params = new URLSearchParams(hash);
    return params.get("access_token"); // pegar pelo nome correto
  }

  async function enviarNovaSenha() {
    const senha = document.getElementById("novaSenha").value.trim();
    const confirma = document.getElementById("confirmSenha").value.trim();
    const token = getTokenFromURL();
    const errorMsg = document.getElementById("error-msg");

    errorMsg.textContent = "";

    if (senha.length < 6) {
      errorMsg.textContent = "A senha deve ter no mínimo 6 caracteres.";
      return;
    }

    if (senha !== confirma) {
      errorMsg.textContent = "As senhas não coincidem.";
      return;
    }

    if (!token) {
      errorMsg.textContent = "Token não encontrado na URL.";
      return; 
    }

    try {
      const response = await fetch("http://localhost:3000/proxy/redefinir-senha", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ novaSenha: senha })
      });

      if (response.ok) {
        mostrarTelaSucesso();
      } else {
        const error = await response.json();
        errorMsg.textContent = error.error || error.message || "Erro ao redefinir a senha.";
      }
    } catch (err) {
      errorMsg.textContent = "Erro de conexão com o servidor.";
    }
  }

  function mostrarTelaSucesso() {
    document.getElementById("form-container").style.display = "none";
    const sucessoContainer = document.getElementById("sucesso-container");
    sucessoContainer.style.display = "block";

    let count = 3;
    const redirectText = document.getElementById("redirect-msg");

    const countdown = setInterval(() => {
      count--;
      if (count > 0) {
        redirectText.textContent = `Redirecionando para o login em ${count}...`;
      } else {
        clearInterval(countdown);
        redirectText.textContent = `Redirecionando...`;
        setTimeout(() => {
          window.location.href = "http://192.168.1.253:3003/";
        }, 600);
      }
    }, 1000);
  }
</script>


</body>
</html>
